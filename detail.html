<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Á´∂È¶¨ÂèéÊîØ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <!-- Year selector -->
    <div class="card">
      <div id="year-selector" class="year-selector"></div>
    </div>

    <!-- Summary -->
    <div class="card summary">
      <div id="profit" class="profit">---</div>
      <div id="roi" class="roi">ROI ---%</div>
      <div id="updated" class="updated">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>

    <!-- Chart -->
    <div class="card">
      <div class="chart-title">Á¥ØË®àÊé®Áßª</div>
      <canvas id="chart"></canvas>
    </div>

    <!-- Weapon Stats -->
    <div class="card">
      <div class="card-title">Ê≠¶Âô®Âà•ÊàêÁ∏æ</div>
      <div id="weapon-stats" class="weapon-stats"></div>
    </div>

    <!-- Weekend selector -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Êó•Âà•ÁµêÊûú</div>
        <div id="month-selector" class="month-selector"></div>
      </div>
      <div id="weekend-selector"></div>
    </div>

    <!-- Daily content -->
    <div class="card" id="daily-card" style="display:none;">
      <div id="daily-content"></div>
    </div>

    <!-- Back link -->
    <a href="index.html" class="detail-link">‚Üê Êàª„Çã</a>
  </div>

  <script>
    let globalData = null;
    let chartInstance = null;
    let currentYear = 2026;
    const availableYears = [2025, 2026];

    function renderYearSelector() {
      const el = document.getElementById('year-selector');
      let html = '';
      availableYears.forEach(y => {
        const active = y === currentYear ? 'active' : '';
        html += `<button class="year-btn ${active}" data-year="${y}">${y}Âπ¥</button>`;
      });
      el.innerHTML = html;

      el.onclick = (e) => {
        const btn = e.target.closest('.year-btn');
        if (btn) {
          const year = parseInt(btn.dataset.year);
          if (year !== currentYear) {
            currentYear = year;
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadData(year);
          }
        }
      };
    }

    async function loadData(year) {
      try {
        const res = await fetch(`data_${year}.json`);
        globalData = await res.json();
        renderSummary();
        renderChart();
        renderWeekendSelector();
        renderWeaponStats();
        // Hide daily card when switching years
        document.getElementById('daily-card').style.display = 'none';
      } catch (e) {
        document.getElementById('profit').textContent = 'Error';
        document.getElementById('updated').textContent = e.message;
      }
    }

    function renderSummary() {
      const profit = globalData.summary.totalProfit;
      const roi = globalData.summary.roi;
      const updated = globalData.lastUpdated;

      const profitEl = document.getElementById('profit');
      profitEl.textContent = (profit >= 0 ? '+' : '') + profit.toLocaleString() + 'ÂÜÜ';
      profitEl.classList.remove('negative');
      if (profit < 0) profitEl.classList.add('negative');

      document.getElementById('roi').textContent = 'ROI ' + roi + '%';
      document.getElementById('updated').textContent = 'ÊúÄÁµÇÊõ¥Êñ∞: ' + updated;
    }

    function renderChart() {
      // Destroy existing chart
      if (chartInstance) {
        chartInstance.destroy();
      }

      const labels = globalData.daily.map(d => d.date.slice(5));
      const values = globalData.daily.map(d => d.cumulative);

      chartInstance = new Chart(document.getElementById('chart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            borderColor: '#4ade80',
            backgroundColor: 'rgba(74, 222, 128, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: values.map(v => v < 0 ? '#f87171' : '#4ade80'),
            segment: {
              borderColor: ctx => {
                const prev = ctx.p0.parsed.y;
                const curr = ctx.p1.parsed.y;
                // Only red if both points are below zero
                return (prev < 0 && curr < 0) ? '#f87171' : '#4ade80';
              }
            }
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              ticks: { color: '#64748b' },
              grid: { color: 'rgba(255,255,255,0.05)' }
            },
            y: {
              ticks: {
                color: '#64748b',
                callback: v => v.toLocaleString() + 'ÂÜÜ'
              },
              grid: { color: 'rgba(255,255,255,0.05)' }
            }
          }
        }
      });
    }

    // 2026 Japanese holidays (month-day format)
    const HOLIDAYS_2026 = {
      '01-01': 'ÂÖÉÊó•',
      '01-12': 'Êàê‰∫∫„ÅÆÊó•',
      '02-11': 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•',
      '02-23': 'Â§©ÁöáË™ïÁîüÊó•',
      '03-20': 'Êò•ÂàÜ„ÅÆÊó•',
      '04-29': 'Êò≠Âíå„ÅÆÊó•',
      '05-03': 'ÊÜ≤Ê≥ïË®òÂøµÊó•',
      '05-04': '„Åø„Å©„Çä„ÅÆÊó•',
      '05-05': '„Åì„Å©„ÇÇ„ÅÆÊó•',
      '05-06': 'ÊåØÊõø‰ºëÊó•',
      '07-20': 'Êµ∑„ÅÆÊó•',
      '08-11': 'Â±±„ÅÆÊó•',
      '09-21': 'Êï¨ËÄÅ„ÅÆÊó•',
      '09-22': 'ÁßãÂàÜ„ÅÆÊó•',
      '10-12': '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•',
      '11-03': 'ÊñáÂåñ„ÅÆÊó•',
      '11-23': 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•'
    };

    function isHoliday(dateStr) {
      const md = dateStr.slice(5); // "MM-DD"
      return HOLIDAYS_2026[md] || null;
    }

    // Global state for month groups and selected month
    let monthGroups = {};
    let selectedMonth = null;

    function renderWeekendSelector() {
      const selectorEl = document.getElementById('weekend-selector');
      const monthSelectorEl = document.getElementById('month-selector');
      const daily = globalData.daily;

      // Build date map
      const dateMap = {};
      daily.forEach(d => { dateMap[d.date] = d; });

      // Find date range
      const dates = daily.map(d => new Date(d.date));
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));

      // Find first Saturday on or before maxDate
      let sat = new Date(maxDate);
      while (sat.getDay() !== 6) {
        sat.setDate(sat.getDate() - 1);
      }

      // Collect all weekends from newest to oldest
      const weekends = [];
      while (sat >= minDate || new Date(sat.getTime() + 86400000) >= minDate) {
        const sun = new Date(sat);
        sun.setDate(sun.getDate() + 1);
        const mon = new Date(sun);
        mon.setDate(mon.getDate() + 1);

        const satStr = sat.toISOString().slice(0, 10);
        const sunStr = sun.toISOString().slice(0, 10);
        const monStr = mon.toISOString().slice(0, 10);

        const satData = dateMap[satStr] || null;
        const sunData = dateMap[sunStr] || null;
        const monData = dateMap[monStr] || null;
        const monHoliday = isHoliday(monStr);

        // Only include if at least one day has data
        if (satData || sunData || (monHoliday && monData)) {
          const month = sat.getMonth() + 1;
          const weekNum = Math.ceil(sat.getDate() / 7);
          weekends.push({
            sat: satStr,
            sun: sunStr,
            mon: monHoliday ? monStr : null,
            satData,
            sunData,
            monData: monHoliday ? monData : null,
            monHoliday,
            label: `${month}Êúà Á¨¨${weekNum}ÈÄ±`
          });
        }

        sat.setDate(sat.getDate() - 7);
      }

      // Sort by date ascending (oldest first)
      weekends.reverse();

      // Group by month
      monthGroups = {};
      weekends.forEach(w => {
        const month = parseInt(w.sat.slice(5, 7));
        if (!monthGroups[month]) monthGroups[month] = [];
        monthGroups[month].push(w);
      });

      // Get all months sorted (ascending for display)
      const months = Object.keys(monthGroups).sort((a, b) => a - b);

      // Default to latest month
      if (!selectedMonth || !monthGroups[selectedMonth]) {
        selectedMonth = months[months.length - 1];
      }

      // Calculate profit for each month
      const monthProfits = {};
      globalData.daily.forEach(d => {
        const m = parseInt(d.date.slice(5, 7));
        if (!monthProfits[m]) monthProfits[m] = 0;
        monthProfits[m] += d.profit;
      });

      // Render month selector buttons
      let monthHtml = '';
      months.forEach(m => {
        const active = m == selectedMonth ? 'active' : '';
        const profit = monthProfits[m] || 0;
        const profitClass = profit >= 0 ? 'positive' : 'negative';
        monthHtml += `<button class="month-btn ${active} ${profitClass}" data-month="${m}">${m}Êúà</button>`;
      });
      monthSelectorEl.innerHTML = monthHtml;

      // Month button click handler
      monthSelectorEl.onclick = (e) => {
        const btn = e.target.closest('.month-btn');
        if (btn) {
          selectedMonth = btn.dataset.month;
          document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderWeekends();
          // Hide daily card when switching months
          document.getElementById('daily-card').style.display = 'none';
        }
      };

      renderWeekends();

      // Day button click handler (delegated)
      selectorEl.onclick = (e) => {
        const btn = e.target.closest('.day-btn');
        if (btn && !btn.disabled) {
          document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('daily-card').style.display = 'block';
          renderDaily(btn.dataset.date);
        }
      };
    }

    function renderWeekends() {
      const selectorEl = document.getElementById('weekend-selector');
      let html = '';

      if (monthGroups[selectedMonth]) {
        monthGroups[selectedMonth].forEach(w => {
          const weekNum = Math.ceil(parseInt(w.sat.slice(8, 10)) / 7);
          const satBtn = renderDayButton(w.sat, w.satData, 'Âúü');
          const sunBtn = renderDayButton(w.sun, w.sunData, 'Êó•');
          const monBtn = w.mon ? renderDayButton(w.mon, w.monData, 'Á•ù') : '';

          const gridCols = w.mon ? 'grid-template-columns: 1fr 1fr 1fr;' : '';
          html += `
            <div class="weekend-group">
              <div class="weekend-label">Á¨¨${weekNum}ÈÄ±</div>
              <div class="weekend-buttons" style="${gridCols}">
                ${satBtn}
                ${sunBtn}
                ${monBtn}
              </div>
            </div>
          `;
        });
      }

      selectorEl.innerHTML = html;
    }

    function renderDayButton(dateStr, data, dow) {
      const day = parseInt(dateStr.slice(8, 10));
      if (!data) {
        return `<button class="day-btn" disabled>
          <div class="day-date">${day}(${dow})</div>
          <div class="day-profit">---</div>
        </button>`;
      }
      const profitClass = data.profit >= 0 ? 'positive' : 'negative';
      const profitText = (data.profit >= 0 ? '+' : '') + data.profit.toLocaleString() + 'ÂÜÜ';
      return `<button class="day-btn ${profitClass}" data-date="${dateStr}">
        <div class="day-date">${day}(${dow})</div>
        <div class="day-profit ${profitClass}">${profitText}</div>
      </button>`;
    }

    function toggleExpand(el) {
      const content = el.nextElementSibling;
      const icon = el.querySelector('.expand-icon');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
      } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
      }
    }

    // Helper: Get horse display string from selection and horses map
    // Helper: Convert number to circled number ‚ë†‚ë°‚ë¢...
    function toCircledNum(n) {
      const num = parseInt(n, 10);
      if (num >= 1 && num <= 20) {
        return String.fromCodePoint(0x2460 + num - 1); // ‚ë† is U+2460
      }
      return String(num);
    }

    // "06" -> "‚ë• „É°„Ç§„Ç∑„Éß„Ç¶„Çø„Éê„É´"
    // "06-11" -> "‚ë•-‚ë™ „É°„Ç§„Ç∑„Éß„Ç¶„Çø„Éê„É´/„Éü„Çπ„ÉÜ„É™„Éº„Ç¶„Çß„Ç§"
    function getHorseDisplay(selection, horses) {
      if (!selection) return '';

      // selection „Çí‰∏∏Êï∞Â≠ó„Å´Â§âÊèõÔºàÊû†Áï™„ÉªÈ¶¨Áï™Âïè„Çè„ÅöÔºâ
      const nums = String(selection).split('-');
      const circledSelection = nums.map(n => toCircledNum(n)).join('-');

      // horses „ÅåÁ©∫„Å™„Çâ selection „ÅÆ„ÅøËøî„Åô
      if (!horses || Object.keys(horses).length === 0) {
        return circledSelection;
      }

      // horses „ÅÆ„Ç≠„Éº„ÇíÊï∞ÂÄ§„Åß„ÇΩ„Éº„Éà„Åó„Å¶„Äå‚ë®È¶¨Âêç/‚ë©È¶¨Âêç„ÄçÂΩ¢Âºè„ÅßË°®Á§∫
      const sortedKeys = Object.keys(horses).sort((a, b) => parseInt(a) - parseInt(b));
      const horseNames = sortedKeys.map(k => toCircledNum(k) + horses[k]).join('/');

      return circledSelection + ' ' + horseNames;
    }

    // Helper: Get bet type abbreviation
    function getBetTypeShort(betType) {
      if (betType === 'ÂçòÂãù') return 'Âçò';
      if (betType === 'Ë§áÂãù') return 'Ë§á';
      return betType;
    }

    // Render daily results
    // Supports both new format (globalData.races) and legacy format (globalData.bets)
    function renderDaily(date) {
      const dayData = globalData.daily.find(d => d.date === date);
      const contentEl = document.getElementById('daily-content');

      const profitClass = dayData.profit >= 0 ? 'positive' : 'negative';
      const profitText = (dayData.profit >= 0 ? '+' : '') + dayData.profit.toLocaleString() + 'ÂÜÜ';

      let html = `<div class="daily-header"><span class="daily-total ${profitClass}">${profitText}</span></div>`;

      // Check for new format (races) or legacy format (bets)
      const hasNewFormat = globalData.races && Object.keys(globalData.races).some(k => k.startsWith(date));

      if (hasNewFormat) {
        // New format: globalData.races[raceKey] = { horses, bets }
        // Filter by raceKey prefix (date is in the key, not in bets)
        const raceKeys = Object.keys(globalData.races).filter(k => k.startsWith(date)).sort();

        raceKeys.forEach(raceKey => {
          const raceData = globalData.races[raceKey];
          const raceName = raceKey.slice(11); // Remove "YYYY-MM-DD_" prefix
          const horses = raceData.horses || {};
          const raceBets = raceData.bets || [];

          html += `<div class="race-block"><div class="race-name">${raceName}</div>`;

          const hasHit = raceBets.some(b => b.payout > 0);
          const raceProfit = raceBets.reduce((sum, b) => sum + (b.payout - b.amount), 0);
          const raceProfitCls = raceProfit >= 0 ? 'win' : 'loss';
          const raceProfitSign = raceProfit >= 0 ? '+' : '';

          if (hasHit) {
            const hitBets = raceBets.filter(b => b.payout > 0);
            const missBets = raceBets.filter(b => b.payout === 0);

            let hitTotal = 0;
            hitBets.forEach(b => {
              const type = getBetTypeShort(b.type || b.betType);
              const display = getHorseDisplay(b.selection, horses);
              const profit = b.payout - b.amount;
              hitTotal += profit;
              html += `<div class="row"><span class="left">${display}</span><span class="right">${type}<span class="loss">-${b.amount}</span> üéØ<span class="win">+${profit.toLocaleString()}</span></span></div>`;
              if (b.weapon && b.weapon !== '-') {
                html += `<div class="row"><span class="left sub">${b.weapon}</span><span class="right"></span></div>`;
              }
            });

            if (missBets.length > 0) {
              const hitTotalCls = hitTotal >= 0 ? 'win' : 'loss';
              const hitTotalSign = hitTotal >= 0 ? '+' : '';
              html += `<div class="row"><span class="left"></span><span class="right">Âèé<span class="${hitTotalCls}">${hitTotalSign}${hitTotal.toLocaleString()}</span></span></div>`;

              const missTotal = missBets.reduce((sum, b) => sum - b.amount, 0);
              html += `<div class="row expand-trigger" onclick="toggleExpand(this)"><span class="left">‰ªñ${missBets.length}ÁÇπ</span><span class="right"><span class="expand-icon">‚ñº</span>Âèé<span class="loss">${missTotal.toLocaleString()}</span></span></div>`;
              html += `<div class="expand-content">`;
              missBets.forEach(b => {
                const type = getBetTypeShort(b.type || b.betType);
                const display = getHorseDisplay(b.selection, horses);
                html += `<div class="row"><span class="left">${display}</span><span class="right">${type}<span class="loss">-${b.amount}</span></span></div>`;
              });
              html += `</div>`;
            }

            html += `<div class="row"><span class="left"></span><span class="right">Âèé<span class="${raceProfitCls}">${raceProfitSign}${raceProfit.toLocaleString()}</span></span></div>`;

          } else {
            // NO HIT
            const tanpuku = raceBets.filter(b => (b.type || b.betType) === 'ÂçòÂãù' || (b.type || b.betType) === 'Ë§áÂãù');
            const others = raceBets.filter(b => (b.type || b.betType) !== 'ÂçòÂãù' && (b.type || b.betType) !== 'Ë§áÂãù');

            // Group tanpuku by selection
            const grouped = {};
            tanpuku.forEach(b => {
              const key = b.selection;
              if (!grouped[key]) grouped[key] = { selection: key, weapon: b.weapon, win: null, place: null };
              if ((b.type || b.betType) === 'ÂçòÂãù') grouped[key].win = b;
              else if ((b.type || b.betType) === 'Ë§áÂãù') grouped[key].place = b;
            });

            let tanpukuTotal = 0;
            Object.values(grouped).forEach(g => {
              let line1Right = '';
              if (g.win) {
                tanpukuTotal -= g.win.amount;
                line1Right += `Âçò<span class="loss">-${g.win.amount}</span>`;
              }
              if (g.place) {
                tanpukuTotal -= g.place.amount;
                if (line1Right) line1Right += ' ';
                line1Right += `Ë§á<span class="loss">-${g.place.amount}</span>`;
              }
              const display = getHorseDisplay(g.selection, horses);
              html += `<div class="row"><span class="left">${display}</span><span class="right">${line1Right}</span></div>`;
              if (g.weapon && g.weapon !== '-') {
                html += `<div class="row"><span class="left sub">${g.weapon}</span><span class="right"></span></div>`;
              }
            });

            if (others.length > 0) {
              if (Object.keys(grouped).length > 0) {
                html += `<div class="row"><span class="left"></span><span class="right">Âèé<span class="loss">${tanpukuTotal.toLocaleString()}</span></span></div>`;
              }

              const othersTotal = others.reduce((sum, b) => sum - b.amount, 0);
              html += `<div class="row expand-trigger" onclick="toggleExpand(this)"><span class="left">‰ªñ${others.length}ÁÇπ</span><span class="right"><span class="expand-icon">‚ñº</span>Âèé<span class="loss">${othersTotal.toLocaleString()}</span></span></div>`;
              html += `<div class="expand-content">`;
              others.forEach(b => {
                const type = getBetTypeShort(b.type || b.betType);
                const display = getHorseDisplay(b.selection, horses);
                html += `<div class="row"><span class="left">${display}</span><span class="right">${type}<span class="loss">-${b.amount}</span></span></div>`;
              });
              html += `</div>`;
            }

            html += `<div class="row"><span class="left"></span><span class="right">Âèé<span class="${raceProfitCls}">${raceProfitSign}${raceProfit.toLocaleString()}</span></span></div>`;
          }

          html += `</div>`;
        });

      } else {
        // Legacy format: globalData.bets[]
        const bets = globalData.bets.filter(b => b.date === date);

        // Group bets by race
        const races = {};
        bets.forEach(b => {
          if (!races[b.race]) races[b.race] = [];
          races[b.race].push(b);
        });

        Object.entries(races).forEach(([race, raceBets]) => {
          html += `<div class="race-block"><div class="race-name">${race}</div>`;

          const hasHit = raceBets.some(b => b.payout > 0);
          const raceProfit = raceBets.reduce((sum, b) => sum + (b.payout - b.amount), 0);
          const raceProfitCls = raceProfit >= 0 ? 'win' : 'loss';
          const raceProfitSign = raceProfit >= 0 ? '+' : '';

          if (hasHit) {
            const hitBets = raceBets.filter(b => b.payout > 0);
            const missBets = raceBets.filter(b => b.payout === 0);

            const hitHorses = {};
            hitBets.forEach(b => {
              const key = b.horse || b.selection;
              const num = b.number || ((b.betType === 'ÂçòÂãù' || b.betType === 'Ë§áÂãù') ? b.selection : null);
              if (!hitHorses[key]) hitHorses[key] = { horse: key, number: num, weapon: b.weapon, bets: [] };
              hitHorses[key].bets.push(b);
            });

            let hitTotal = 0;
            Object.values(hitHorses).forEach(h => {
              let line1Right = '';
              h.bets.forEach(b => {
                const type = getBetTypeShort(b.betType);
                const profit = b.payout - b.amount;
                hitTotal += profit;
                if (line1Right) line1Right += ' ';
                line1Right += `${type}<span class="loss">-${b.amount}</span> üéØ<span class="win">+${profit.toLocaleString()}</span>`;
              });
              const numStr = h.number ? h.number + ' ' : '';
              html += `<div class="row"><span class="left">${numStr}${h.horse}</span><span class="right">${line1Right}</span></div>`;
              if (h.weapon && h.weapon !== '-') {
                html += `<div class="row"><span class="left sub">${h.weapon}</span><span class="right"></span></div>`;
              }
            });

            if (missBets.length > 0) {
              const hitTotalCls = hitTotal >= 0 ? 'win' : 'loss';
              const hitTotalSign = hitTotal >= 0 ? '+' : '';
              html += `<div class="row"><span class="left"></span><span class="right">Âèé<span class="${hitTotalCls}">${hitTotalSign}${hitTotal.toLocaleString()}</span></span></div>`;

              const missTotal = missBets.reduce((sum, b) => sum - b.amount, 0);
              html += `<div class="row expand-trigger" onclick="toggleExpand(this)"><span class="left">‰ªñ${missBets.length}ÁÇπ</span><span class="right"><span class="expand-icon">‚ñº</span>Âèé<span class="loss">${missTotal.toLocaleString()}</span></span></div>`;
              html += `<div class="expand-content">`;
              missBets.forEach(b => {
                const type = getBetTypeShort(b.betType);
                const name = b.horse || b.selection;
                const num = b.number || ((b.betType === 'ÂçòÂãù' || b.betType === 'Ë§áÂãù') ? b.selection : null);
                const numStr = num ? num + ' ' : '';
                html += `<div class="row"><span class="left">${numStr}${name}</span><span class="right">${type}<span class="loss">-${b.amount}</span></span></div>`;
              });
              html += `</div>`;
            }

            html += `<div class="row"><span class="left"></span><span class="right">Âèé<span class="${raceProfitCls}">${raceProfitSign}${raceProfit.toLocaleString()}</span></span></div>`;

          } else {
            const tanpuku = raceBets.filter(b => b.betType === 'ÂçòÂãù' || b.betType === 'Ë§áÂãù');
            const others = raceBets.filter(b => b.betType !== 'ÂçòÂãù' && b.betType !== 'Ë§áÂãù');

            const horses = {};
            tanpuku.forEach(b => {
              const key = b.horse || b.selection;
              const num = b.number || b.selection;
              if (!horses[key]) horses[key] = { horse: key, number: num, weapon: b.weapon, win: null, place: null };
              if (b.betType === 'ÂçòÂãù') horses[key].win = b;
              else if (b.betType === 'Ë§áÂãù') horses[key].place = b;
            });

            let tanpukuTotal = 0;
            Object.values(horses).forEach(h => {
              let line1Right = '';
              if (h.win) {
                tanpukuTotal -= h.win.amount;
                line1Right += `Âçò<span class="loss">-${h.win.amount}</span>`;
              }
              if (h.place) {
                tanpukuTotal -= h.place.amount;
                if (line1Right) line1Right += ' ';
                line1Right += `Ë§á<span class="loss">-${h.place.amount}</span>`;
              }
              const numStr = h.number ? h.number + ' ' : '';
              html += `<div class="row"><span class="left">${numStr}${h.horse}</span><span class="right">${line1Right}</span></div>`;
              if (h.weapon && h.weapon !== '-') {
                html += `<div class="row"><span class="left sub">${h.weapon}</span><span class="right"></span></div>`;
              }
            });

            if (others.length > 0) {
              if (Object.keys(horses).length > 0) {
                html += `<div class="row"><span class="left"></span><span class="right">Âèé<span class="loss">${tanpukuTotal.toLocaleString()}</span></span></div>`;
              }

              const othersTotal = others.reduce((sum, b) => sum - b.amount, 0);
              html += `<div class="row expand-trigger" onclick="toggleExpand(this)"><span class="left">‰ªñ${others.length}ÁÇπ</span><span class="right"><span class="expand-icon">‚ñº</span>Âèé<span class="loss">${othersTotal.toLocaleString()}</span></span></div>`;
              html += `<div class="expand-content">`;
              others.forEach(b => {
                const type = getBetTypeShort(b.betType);
                const name = b.horse || b.selection;
                const numStr = b.number ? b.number + ' ' : '';
                html += `<div class="row"><span class="left">${numStr}${name}</span><span class="right">${type}<span class="loss">-${b.amount}</span></span></div>`;
              });
              html += `</div>`;
            }

            html += `<div class="row"><span class="left"></span><span class="right">Âèé<span class="${raceProfitCls}">${raceProfitSign}${raceProfit.toLocaleString()}</span></span></div>`;
          }

          html += `</div>`;
        });
      }

      contentEl.innerHTML = html;
    }

    function renderWeaponStats() {
      const ws = globalData.weaponStats;
      const wb = globalData.weaponBreakdown;
      const el = document.getElementById('weapon-stats');

      if (!ws || Object.keys(ws).length === 0) {
        el.innerHTML = '<div style="color:#64748b;font-size:13px;">Ê≠¶Âô®„Éá„Éº„Çø„Å™„Åó</div>';
        return;
      }

      let html = '<div class="weapon-overview">';

      // Double vs Single
      if (ws.double) {
        const dCls = ws.double.roi >= 100 ? 'positive' : 'negative';
        html += `<div class="weapon-card">
          <div class="weapon-name">2Ê≠¶Âô®‰ª•‰∏ä</div>
          <div class="weapon-roi ${dCls}">ROI ${ws.double.roi}%</div>
          <div class="weapon-detail">${ws.double.count}‰ª∂ / ${ws.double.hits}ÁöÑ‰∏≠</div>
        </div>`;
      }
      if (ws.single) {
        const sCls = ws.single.roi >= 100 ? 'positive' : 'negative';
        html += `<div class="weapon-card">
          <div class="weapon-name">ÂçòÁã¨Ê≠¶Âô®</div>
          <div class="weapon-roi ${sCls}">ROI ${ws.single.roi}%</div>
          <div class="weapon-detail">${ws.single.count}‰ª∂ / ${ws.single.hits}ÁöÑ‰∏≠</div>
        </div>`;
      }

      html += '</div>';

      // Breakdown
      if (wb && wb.length > 0) {
        html += '<details class="weapon-breakdown"><summary>Ê≠¶Âô®Âà•ÂÜÖË®≥</summary><table class="data-table"><thead><tr><th>Ê≠¶Âô®</th><th>‰ª∂Êï∞</th><th>ÁöÑ‰∏≠</th><th>ÁöÑ‰∏≠Áéá</th></tr></thead><tbody>';
        wb.forEach(w => {
          html += `<tr><td>${w.weapon}</td><td>${w.count}</td><td>${w.hits}</td><td>${w.hitRate}%</td></tr>`;
        });
        html += '</tbody></table></details>';
      }

      el.innerHTML = html;
    }

    renderYearSelector();
    loadData(currentYear);
  </script>
</body>
</html>
